{
    "version": "https://jsonfeed.org/version/1",
    "title": "筆記ZONE • All posts by \"ci/cd\" tag",
    "description": "",
    "home_page_url": "https://zonego.tw",
    "items": [
        {
            "id": "https://zonego.tw/2022/01/06/drone-git-push/",
            "url": "https://zonego.tw/2022/01/06/drone-git-push/",
            "title": "drone-git-push 踩雷心得",
            "date_published": "2022-01-06T12:15:54.000Z",
            "content_html": "<p><a href=\"https://www.drone.io/\">Drone CI</a> 是一個可以自行的 CI (Continuous Integration) 軟體</p>\n<p>使用 CI 的用意就是為了，能在寫完程式時，自動測試、編譯與發佈程式。</p>\n<span id=\"more\"></span>\n\n<p>關於怎麼架設改天再寫一篇教學。 <del>Google一下應該就很多教學了</del></p>\n<h2 id=\"drone-git-push\"><a href=\"#drone-git-push\" class=\"headerlink\" title=\"drone-git-push\"></a>drone-git-push</h2><p>回來本篇主題</p>\n<p>這次我的需求是在 Drone 的流程內，測試或編譯完程式後以 git 推送到不同的儲藏庫</p>\n<p>其實就是要產生網站檔案後，推送到 GitHub 方便用 GitHub Page 或是 Cloudflare Page</p>\n<p>在 Drone CI 中可以用 <a href=\"http://plugins.drone.io/appleboy/drone-git-push/\">drone-git-push</a> 做到</p>\n<p>這次遇到的問題有2個 <del>害我為了找問題多花很多時間</del></p>\n<h2 id=\"儲存庫辨識失敗\"><a href=\"#儲存庫辨識失敗\" class=\"headerlink\" title=\"儲存庫辨識失敗\"></a>儲存庫辨識失敗</h2><p>錯誤訊息:</p>\n<figure class=\"highlight node-repl\"><table><tr><td class=\"code\"><pre><code class=\"hljs node-repl\"><span class=\"hljs-meta prompt_\">...</span><br>parse \\&quot;git@github.com:user/repo.git\\&quot;: first path segment in URL cannot contain colon&quot;<br><span class=\"hljs-meta prompt_\">...</span><br></code></pre></td></tr></table></figure>\n\n<p>照原本文件寫的 <code>.drone.yml</code> 大概是長這樣</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">deploy</span> <span class=\"hljs-string\">git</span><br>  <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">appleboy/drone-git-push</span><br>  <span class=\"hljs-attr\">settings:</span><br>    <span class=\"hljs-attr\">branch:</span> <span class=\"hljs-string\">main</span><br>    <span class=\"hljs-attr\">remote:</span> <span class=\"hljs-string\">git@github.com:user/repo.git</span><br>    <span class=\"hljs-attr\">force:</span> <span class=\"hljs-literal\">false</span><br>    <span class=\"hljs-attr\">commit:</span> <span class=\"hljs-literal\">true</span><br></code></pre></td></tr></table></figure>\n\n<p>參考<a href=\"https://github.com/appleboy/drone-git-push/issues/40\">GitHub討論區</a>的解決方法</p>\n<ul>\n<li>使用緊急修補的 image</li>\n<li>remote 改用字串</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">deploy</span> <span class=\"hljs-string\">git</span><br>  <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">appleboy/drone-git-push:0.2.0-linux-amd64</span><br>  <span class=\"hljs-attr\">settings:</span><br>    <span class=\"hljs-attr\">branch:</span> <span class=\"hljs-string\">main</span><br>    <span class=\"hljs-attr\">remote:</span> <span class=\"hljs-string\">&quot;git@github.com:user/repo.git&quot;</span><br>    <span class=\"hljs-attr\">force:</span> <span class=\"hljs-literal\">false</span><br>    <span class=\"hljs-attr\">commit:</span> <span class=\"hljs-literal\">true</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"SSH-Key-讀取失敗\"><a href=\"#SSH-Key-讀取失敗\" class=\"headerlink\" title=\"SSH Key 讀取失敗\"></a>SSH Key 讀取失敗</h2><p>由於資安的關係， SSH KEY 不可以跟著程式碼推送到儲存庫，更不可能放明碼在設定檔中</p>\n<p>在 Drone CI 要改用 secret 的功能</p>\n<p><code>.drone.yml</code> 大概長這樣</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">deploy</span> <span class=\"hljs-string\">git</span><br>  <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">appleboy/drone-git-push:0.2.0-linux-amd64</span><br>  <span class=\"hljs-attr\">settings:</span><br>    <span class=\"hljs-attr\">branch:</span> <span class=\"hljs-string\">main</span><br>    <span class=\"hljs-attr\">ssh_key:</span><br>      <span class=\"hljs-attr\">from_secret:</span> <span class=\"hljs-string\">githubkey</span><br></code></pre></td></tr></table></figure>\n\n<p>另外在 Drone CI 的 WebUI 上添加 Secret</p>\n<p>將 private key 的內文貼進去</p>\n<p><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/DroneCI-secret.png\" alt=\"secret\" data-caption=\"secret\" loading=\"lazy\"></p>\n<p>然後就碰到問題了</p>\n<p>錯誤訊息:</p>\n<figure class=\"highlight node-repl\"><table><tr><td class=\"code\"><pre><code class=\"hljs node-repl\"><span class=\"hljs-meta prompt_\">...</span><br>Load key &quot;/root/.ssh/id_rsa&quot;: invalid format<br><span class=\"hljs-meta prompt_\">...</span><br></code></pre></td></tr></table></figure>\n\n<p>參考<a href=\"https://github.com/appleboy/drone-git-push/issues/37\">GitHub討論區</a>的解決方法</p>\n<ul>\n<li>產生的 SSH key 需要改用 PEM</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><code class=\"hljs bash\">ssh-keygen -t rsa -b 4096 -C <span class=\"hljs-string\">&quot;your_email@example.com&quot;</span> -m PEM<br></code></pre></td></tr></table></figure>\n\n<p>換完 KEY 甚麼問題都沒了🎉</p>\n",
            "tags": [
                "Git",
                "CI/CD",
                "Drone"
            ]
        }
    ]
}
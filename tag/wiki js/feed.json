{
    "version": "https://jsonfeed.org/version/1",
    "title": "筆記ZONE • All posts by \"wiki js\" tag",
    "description": "",
    "home_page_url": "https://zonego.tw",
    "items": [
        {
            "id": "https://zonego.tw/2023/02/10/wikijs-keyckoak/",
            "url": "https://zonego.tw/2023/02/10/wikijs-keyckoak/",
            "title": "設定 WikiJS 使用 Keyckoak 做身分認證",
            "date_published": "2023-02-10T06:35:35.000Z",
            "content_html": "<p>最近在設定 WikiJS 串接 Keycloak 作身分認證時碰到一些問題，所以在這邊做個紀錄<br>這邊就跳過安裝過程</p>\n<span id=\"more\"></span>\n\n<p>紀錄時使用版本： <code>WikiJS 2.5.296</code>  <code>Keycloak 20.0.3</code></p>\n<h2 id=\"Keycloak-設定\"><a href=\"#Keycloak-設定\" class=\"headerlink\" title=\"Keycloak 設定\"></a>Keycloak 設定</h2><p>挑選你要設定登入的 realm ，這邊我為了不要應用程式的帳號跟 Keycloak 的管理帳號混用，建一個新的 realm 叫做 demo</p>\n<blockquote>\n<p>realm 像是用來管理帳號的群組，在這個群組內建好的應用方式都可以透過這些帳號登入</p>\n</blockquote>\n<h3 id=\"新增-client\"><a href=\"#新增-client\" class=\"headerlink\" title=\"新增 client\"></a>新增 client</h3><p><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-new_client.png\" alt=\"creat\" data-caption=\"creat\" loading=\"lazy\"></p>\n<p>打上 client ID (不可重複) ，next 下一步<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-new_client2.png\" alt=\"creat\" data-caption=\"creat\" loading=\"lazy\"></p>\n<p>這邊 Client authentication 必須要勾選，才會產生後面要用到的 Client Secret。點 Save 儲存<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-new_client3.png\" alt=\"creat\" data-caption=\"creat\" loading=\"lazy\"></p>\n<h3 id=\"設定-client\"><a href=\"#設定-client\" class=\"headerlink\" title=\"設定 client\"></a>設定 client</h3><p>打開剛剛建好的 client <code>wiki</code><br>下滑到 Access Setting<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-access-setting.png\" alt=\"setting\" data-caption=\"setting\" loading=\"lazy\"></p>\n<p>假設我們的 wikijs 網址是 <a href=\"https://wiki.example.com/\">https://wiki.example.com</a></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>填入URL</th>\n<th>說明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Root URL</td>\n<td><a href=\"https://wiki.example.com/\">https://wiki.example.com</a></td>\n<td>網站根網址</td>\n</tr>\n<tr>\n<td>Home URL</td>\n<td><a href=\"https://wiki.example.com/\">https://wiki.example.com</a></td>\n<td>登入後重導向的根網址 (通常跟 root url 相同)</td>\n</tr>\n<tr>\n<td>Valid rediect URIs</td>\n<td>&#x2F;XXXXXXXX&#x2F;callback<br>&#x2F;*</td>\n<td>允許重導向頁面網址<br>用 * 可以代表所有頁面，但要注意安全性</td>\n</tr>\n<tr>\n<td>Valid post logout</td>\n<td><a href=\"https://wiki.example.com/\">https://wiki.example.com</a></td>\n<td>允許登出後轉向的頁面</td>\n</tr>\n<tr>\n<td>redirect URIs</td>\n<td>&#x2F;*</td>\n<td>允許登出後的重導向位置</td>\n</tr>\n<tr>\n<td>Web origins</td>\n<td></td>\n<td>允許 CORS origins 的網址</td>\n</tr>\n</tbody></table>\n<p><code>Valid rediect URIs</code> 可以在後面設定 wikijs 時取得</p>\n<p>如果你的 Keycloak 有安裝客製主題，可以在 Login settings 裡修改<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-login-theme.png\" alt=\"setting\" data-caption=\"setting\" loading=\"lazy\"></p>\n<p>Credentials 分頁有後續會用到的 client key，可以先複製<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-client_key.png\" alt=\"setting\" data-caption=\"setting\" loading=\"lazy\"></p>\n<h2 id=\"Wikijs-設定\"><a href=\"#Wikijs-設定\" class=\"headerlink\" title=\"Wikijs 設定\"></a>Wikijs 設定</h2><p>進到設定後選認證 &gt; 新增登入機制<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-provider.png\" alt=\"wikijs\" data-caption=\"wikijs\" loading=\"lazy\"></p>\n<p>選擇 Keycloak<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-provider2.png\" alt=\"wikijs\" data-caption=\"wikijs\" loading=\"lazy\"></p>\n<p>再來填入你的 Keycloak 網址、realm 名稱跟剛剛建好的 Client ID<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-provider3.png\" alt=\"wikijs\" data-caption=\"wikijs\" loading=\"lazy\"></p>\n<p>下面4個網址可以參考 wikijs 的提示，不過左邊的 <code>/auth</code> 要去掉，例如：</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"code\"><pre><code class=\"hljs awk\">wikij 提示<br>https:<span class=\"hljs-regexp\">//</span>KEYCLOAK-HOST<span class=\"hljs-regexp\">/auth/</span>realms<span class=\"hljs-regexp\">/YOUR-REALM/</span>protocol<span class=\"hljs-regexp\">/openid-connect/</span>auth<br><br>左邊的 /auth 去掉，範例的 realms 是 demo<br>https:<span class=\"hljs-regexp\">//y</span>our.keycloak-host.com<span class=\"hljs-regexp\">/realms/</span>demo<span class=\"hljs-regexp\">/protocol/</span>openid-connect/auth<br></code></pre></td></tr></table></figure>\n\n<p>Client Secret 貼上 Keycloak Credentials 內複製的金鑰<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-provider4.png\" alt=\"wikijs\" data-caption=\"wikijs\" loading=\"lazy\"></p>\n<p>開放自由註冊可以斟酌打開，若沒開沒登入過的帳號會無法登入<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-provider5.png\" alt=\"wikijs\" data-caption=\"wikijs\" loading=\"lazy\"></p>\n<p>最下面可以取得 keycloak 設定需要的 Valid rediect URI<br>只需要填 &#x2F;login&#x2F;a28088b1-8e47-4d16-aa6f-0a32d8af192f&#x2F;callback<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-provider6.png\" alt=\"wikijs\" data-caption=\"wikijs\" loading=\"lazy\"></p>\n<p>設定完記得卷到上面點套用設定<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-provider3.png\" alt=\"wikijs\" data-caption=\"wikijs\" loading=\"lazy\"></p>\n<hr>\n<h2 id=\"問題排除\"><a href=\"#問題排除\" class=\"headerlink\" title=\"問題排除\"></a>問題排除</h2><h3 id=\"登出時遇到-invalid-parameter-redirect-uri\"><a href=\"#登出時遇到-invalid-parameter-redirect-uri\" class=\"headerlink\" title=\"登出時遇到 invalid parameter redirect_uri\"></a>登出時遇到 invalid parameter redirect_uri</h3><p><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/invalid-parameter-redirect_uri.png\" alt=\"invalid parameter redirect_uri\" data-caption=\"invalid parameter redirect_uri\" loading=\"lazy\"></p>\n<p>keycloak 在 18 版之後就不支援登出時使用<code>redirect_uri</code>參數，所以只能先暫時先把 WikiJS 的同步登出先關閉，等 WikiJS 更新<br><img onerror=\"imgOnError(this);\" data-fancybox=\"gallery\" src=\"/images/content/keycloak-wikijs-provider5.png\" alt=\"WikiJS sync logout\" data-caption=\"WikiJS sync logout\" loading=\"lazy\"></p>\n<blockquote>\n<p>關閉後的缺點是在同一台裝置，session 未過期前，點一下 keycloak 登入就會自動登進去</p>\n</blockquote>\n",
            "tags": [
                "Self-Hosting",
                "Wiki JS",
                "Keyckoak",
                "身分認證"
            ]
        }
    ]
}